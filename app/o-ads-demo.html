<!DOCTYPE html>
<html class="js enhanced" data-next-app="front-page">
 <head>
 <meta charset="utf-8" />
 <meta http-equiv="X-UA-Compatible" content="IE=edge" />
 <title>FT中文网</title>
 <meta http-equiv="Content-Language" content="zh-CN"/>
 <meta name="apple-mobile-web-app-status-bar-style" content="black" />
 <link rel="apple-touch-icon-precomposed" href="https://d2785ji6wtdqx8.cloudfront.net/img/ipad_icon.png" />
 <meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link rel="stylesheet" href="styles/main-pop-ad.css">
<link rel="stylesheet" href="styles/main-paid-post.css">
<link rel="stylesheet" href="styles/main-default.css">

<style>
body {
    padding: clamp(1rem, 3vw, 2.5rem);
    background: #fff7ef;
}
h2 {
    color: #9e2f50;
    font-size: 1.15rem;
}
.ad-set {
    border: 2px dashed #d8b59c;
    padding: 1.5rem;
    margin-bottom: 2rem;
    background: #fff;
}
.ad-set__label {
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.2em;
    color: #a06c4b;
    margin-bottom: 1rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}
.ad-set__label::before,
.ad-set__label::after {
    content: '';
    flex: 1;
    height: 1px;
    background: repeating-linear-gradient(90deg, #a06c4b, #a06c4b 6px, transparent 6px, transparent 12px);
}

.clone-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    border: 1px solid #9e2f50;
    background: #fff;
    color: #9e2f50;
    font-weight: 600;
    padding: 0.6rem 1.2rem;
    border-radius: 999px;
    cursor: pointer;
    margin: 1rem 0 2rem;
}
.clone-btn:active {
    transform: scale(0.98);
}
.ad-set--inactive {
    opacity: 0.35;
}
pre {
    background: #0f172a;
    color: #f8fafc;
    padding: 1rem;
    overflow-x: auto;
}
</style>

<script type="text/javascript" src="scripts/key.js"></script>
<script type="text/javascript" src="scripts/ad-polyfill.js"></script>

<script type="text/javascript">
function parseUserkv(n){var c={},i=n.split(";");if(0!==i.length)return i.forEach(function(n){var i=n.split("|");2===i.length&&(c[i[0]]=i[1])}),c}function getDfpTargetingStr(n){var c="";return n.sex&&(c+="cnsex="+n.sex+";"),n.cs&&(c+="cncs="+n.cs+";"),n.csp&&(c+="cncsp="+n.csp+";"),n.hi&&(c+="cnhi="+n.hi+";"),n.in&&(c+="cnin="+n.in+";"),n.wf&&(c+="cnwf="+n.wf+";"),c}</script>
<script>
// --- CORE FUNCTIONS ---

/**
 * FINAL STRATEGY: Manual GPT Definition + Responsive Size Mapping.
 * This bypasses oAds.init() bugs and manually sets up responsive logic via GPT API.
 */
function reInitializeAds(container) {
    if (!container || !window.googletag || !window.cachedConfig) {
        console.warn('[o-ads-demo] Re-initialization prerequisites missing.');
        return;
    }

    window.googletag.cmd.push(function() {
        var setIndex = container.getAttribute('data-set-index');
        var slotEls = Array.prototype.slice.call(container.querySelectorAll('.o-ads'));
        var uniqueId = 'nav' + setIndex; 
        
        var adUnitPath = '/' + window.cachedConfig.gpt.network + 
                         '/' + window.cachedConfig.gpt.site + 
                         '/' + window.cachedConfig.gpt.zone;
        
        var newGptSlots = [];

        console.log('[o-ads-demo] Manual GPT Definition started for Set #' + setIndex);

        slotEls.forEach(function (slot) {
            var name = slot.getAttribute('data-o-ads-name');
            var slotId = 'gpt-' + name + '-' + setIndex; 

            // 1. Determine Responsive Sizes
            // Read format names from attributes and lookup sizes in config
            var smallFormat = slot.getAttribute('data-o-ads-formats-small');
            var largeFormat = slot.getAttribute('data-o-ads-formats-large') || slot.getAttribute('data-o-ads-formats-medium'); // Fallback for medium/default

            var smallSizes = (smallFormat && smallFormat !== 'false' && window.cachedConfig.formats[smallFormat]) 
                             ? window.cachedConfig.formats[smallFormat].sizes 
                             : []; // Empty array means "hide ad on this device"

            var largeSizes = (largeFormat && largeFormat !== 'false' && window.cachedConfig.formats[largeFormat]) 
                             ? window.cachedConfig.formats[largeFormat].sizes 
                             : [];

            // Construct the "General" size list (Union of all possible sizes for definition)
            // If both are empty, fallback to a default 300x250 to prevent crash.
            var allSizes = [].concat(smallSizes, largeSizes);
            if (allSizes.length === 0) allSizes = [[300, 250]]; 

            // 2. DOM Cleanup
            slot.id = slotId; 
            slot.removeAttribute('data-o-ads-loaded');
            slot.classList.remove('o-ads--empty');
            while (slot.firstChild) {
                slot.removeChild(slot.firstChild);
            }

            try {
                // 3. Define Slot with Union of Sizes
                var gptSlot = window.googletag.defineSlot(adUnitPath, allSizes, slotId);
                
                if (gptSlot) {
                    // 4. Build & Apply Responsive Mapping
                    // Logic: If viewport >= 990px (Desktop), use LargeSizes. 
                    //        If viewport < 990px (Mobile), use SmallSizes.
                    // Note: Empty array in mapping means "suppress ad".
                    var mapping = window.googletag.sizeMapping()
                        .addSize([990, 0], largeSizes) // Desktop Breakpoint
                        .addSize([0, 0], smallSizes)   // Mobile Breakpoint
                        .build();

                    gptSlot.defineSizeMapping(mapping);

                    // 5. Targeting
                    var targetingAttr = slot.getAttribute('data-o-ads-targeting');
                    var cnposMatch = targetingAttr ? targetingAttr.match(/cnpos=([^;]+)/) : null;
                    var cnpos = cnposMatch ? cnposMatch[1] : 'unknown';

                    gptSlot.setTargeting('cnpos', cnpos);
                    gptSlot.setTargeting('navid', uniqueId);
                    
                    gptSlot.addService(window.googletag.pubads());

                    // 6. Register Display
                    window.googletag.display(slotId);
                    newGptSlots.push(gptSlot);
                    
                    // Debug log for verified sizes
                    // console.log('[o-ads-demo] Defined:', name, 'Small:', JSON.stringify(smallSizes), 'Large:', JSON.stringify(largeSizes));
                }
            } catch (err) {
                console.error('[o-ads-demo] GPT Definition Failed:', name, err);
            }
        });

        // 7. Refresh to fetch ads (bypass lazy load default)
        if (newGptSlots.length > 0) {
            console.log('[o-ads-demo] Triggering refresh for', newGptSlots.length, 'slots...');
            window.googletag.pubads().refresh(newGptSlots);
        }
    });
}

function destroyAllAdSlots() {
    if (window.googletag && typeof window.googletag.destroySlots === 'function') {
        window.googletag.cmd.push(function() {
            window.googletag.destroySlots();
            console.log('[o-ads-demo] GPT slots destroyed.');
        });
    }
    if (window.oAds && window.oAds.slots) {
        var slotMap = window.oAds.slots;
        Object.keys(slotMap).forEach(function(key) {
             if (key !== 'lazyLoadingObservers') delete slotMap[key];
        });
        console.log('[o-ads-demo] OAds map cleared.');
    }
}

function removeAllAdSets() {
    Array.prototype.slice.call(document.querySelectorAll('.ad-set')).forEach(function (set) {
        if (set.parentNode) set.parentNode.removeChild(set);
    });
}

function logRegisteredSlots(prefix) {
    if (window.oAds && window.oAds.slots) {
        console.log('[o-ads-demo]', prefix, Object.keys(window.oAds.slots));
    }
}

// MARK: - Configuration Setup
var userKv = GetCookie('USER_KV');
var dfpTargetingStr = '';
if (userKv) {
    var userKvObj = parseUserkv(userKv);
    dfpTargetingStr = getDfpTargetingStr(userKvObj);
}
if (gUserType && gUserType !== '') {
    dfpTargetingStr = 'cnuser=' + gUserType + ';' + dfpTargetingStr;
}
var configJson = JSON.stringify({
    gpt: { "network": 21753042392, "site": "FtChinese", "zone": 'home' },
    collapseEmpty: 'before',
    dfp_targeting: dfpTargetingStr,
    formats: {
        "FtcLeaderboard" : { "sizes":[[1200, 120], [1200, 400], [1200, 250], [969, 90], [969, 400], [969, 250]] },
        "FtcBanner": { "sizes":[[1200, 120], [969, 90]] },
        "FtcMobileBanner": { "sizes": [[414, 104]] },
        "FtcMobileMpu":{ "sizes":[[300, 250]] },
        "FtcMpu":{ "sizes":[[300, 250], [300, 600], [300,1050]] },
        "FtcInfoFlow":{ "sizes":[[400, 300]] },
        "FtcMobileFullscreen": { "sizes":[[414, 736]] },
        "FtcPcFullscreen":{ "sizes":[[700, 520]] },
        "FtcPaidpost":{ "sizes":[[280, 350]] },
        "FtcRibbon":{ "sizes":[[300, 60]] },
        "FtcMembertext":{ "sizes":[[300, 47]] }
    }
});
var configScriptJsonStr = '<scr'+'ipt data-o-ads-config="" type="application/json">'+configJson+'</scr'+'ipt>';
document.writeln(configScriptJsonStr);

// CACHE CONFIG FOR SPA USE
window.cachedConfig = JSON.parse(configJson); 
</script>
</head>
<body>

<div id="ad-slots" class="ad-set" data-set-index="0">
<div class="ad-set__label">Ad Set #0</div>
<h2>Ad Slot: banner1</h2>
<div class="o-ads" data-o-ads-name="banner1"
              data-o-ads-center="true" 
              data-o-ads-formats-default="false" 
              data-o-ads-formats-small="FtcMobileBanner" 
              data-o-ads-formats-medium="false"
              data-o-ads-formats-large="FtcLeaderboard"
              data-o-ads-formats-extra="FtcLeaderboard"
              data-o-ads-targeting="cnpos=top1;"
              data-cy='[{"devices":["PC"],"pattern":"Leaderboard","position":"Num1"}]'>
          </div>

<h2>Ad Slot: infoflow1</h2>
<div data-o-ads-name="infoflow1" class="o-ads infoflow" data-o-ads-formats-default="false" data-o-ads-formats-small="FtcInfoFlow" data-o-ads-formats-medium="false" data-o-ads-formats-large="false" data-o-ads-formats-extra="false" data-o-ads-targeting="cnpos=info1;" ></div>

<h2>Ad Slot: mpu-middle1</h2>
<div data-o-ads-name="mpu-middle1" class="o-ads" data-o-ads-formats-default="false" data-o-ads-formats-small="FtcMobileMpu" data-o-ads-formats-medium="false" data-o-ads-formats-large="false" data-o-ads-formats-extra="false" data-o-ads-targeting="cnpos=middle1;" data-cy='[{"devices":["iPhoneWeb","AndroidWeb","iPhoneApp","AndroidApp"],"pattern":"MPU","position":"Middle1"}]'></div>

<h2>Ad Slot: infoflow2</h2>
<div data-o-ads-name="infoflow2" class="o-ads infoflow" data-o-ads-formats-default="false" data-o-ads-formats-small="FtcInfoFlow" data-o-ads-formats-medium="false" data-o-ads-formats-large="false" data-o-ads-formats-extra="false" data-o-ads-targeting="cnpos=info2;" ></div>

<h2>Ad Slot: mpu-middle2</h2>
<div data-o-ads-name="mpu-middle2" class="o-ads" data-o-ads-formats-default="false" data-o-ads-formats-small="FtcMobileMpu" data-o-ads-formats-medium="false" data-o-ads-formats-large="false" data-o-ads-formats-extra="false" data-o-ads-targeting="cnpos=middle2;" data-cy='[{"devices":["iPhoneWeb","AndroidWeb","iPhoneApp","AndroidApp"],"pattern":"MPU","position":"Middle2"}]'></div>

<h2>Ad Slot: infoflow3</h2>
<div data-o-ads-name="infoflow3" class="o-ads infoflow" data-o-ads-formats-default="false" data-o-ads-formats-small="FtcInfoFlow" data-o-ads-formats-medium="false" data-o-ads-formats-large="false" data-o-ads-formats-extra="false" data-o-ads-targeting="cnpos=info3;" ></div>

<h2>Ad Slot: mpu-middle3</h2>
<div data-o-ads-name="mpu-middle3" class="o-ads" data-o-ads-formats-default="false" data-o-ads-formats-small="FtcMobileMpu" data-o-ads-formats-medium="false" data-o-ads-formats-large="false" data-o-ads-formats-extra="false" data-o-ads-targeting="cnpos=middle3;" data-cy='[{"devices":["iPhoneWeb","AndroidWeb","iPhoneApp","AndroidApp"],"pattern":"MPU","position":"Middle3"}]'></div>

<h2>Ad Slot: infoflow4</h2>
<div data-o-ads-name="infoflow4" class="o-ads infoflow" data-o-ads-formats-default="false" data-o-ads-formats-small="FtcInfoFlow" data-o-ads-formats-medium="false" data-o-ads-formats-large="false" data-o-ads-formats-extra="false" data-o-ads-targeting="cnpos=info4;" ></div>

<h2>Ad Slot: mpu-middle4</h2>
<div data-o-ads-name="mpu-middle4" class="o-ads" data-o-ads-formats-default="false" data-o-ads-formats-small="FtcMobileMpu" data-o-ads-formats-medium="false" data-o-ads-formats-large="false" data-o-ads-formats-extra="false" data-o-ads-targeting="cnpos=middle4;" data-cy='[{"devices":["iPhoneWeb","AndroidWeb","iPhoneApp","AndroidApp"],"pattern":"MPU","position":"Middle4"}]'></div>

<h2>Ad Slot: ribbon</h2>
<div
                data-o-ads-name="ribbon" 
                class="o-ads"
                data-o-ads-formats-default="false"
                data-o-ads-formats-small="false"
                data-o-ads-formats-medium="false"
                data-o-ads-formats-large="FtcRibbon"
                data-o-ads-targeting="cnpos=ribbon;"
            >
            </div>

<h2>Ad Slot: mpu-right1</h2>
<div 
            data-o-ads-name="mpu-right1"
            class="o-ads"  
            data-o-ads-formats-default="false" 
            data-o-ads-formats-small="false" 
            data-o-ads-formats-medium="FtcMpu"
            data-o-ads-formats-large="FtcMpu"
            data-o-ads-formats-extra="FtcMpu"
            data-o-ads-targeting="cnpos=right1;"
            data-cy='[{"devices":["PC","PadWeb","PadApp"],"pattern":"MPU","position":"Right1"}]'
            
            >
            </div>

<h2>Ad Slot: mpu-middle5</h2>
<div 
            data-o-ads-name="mpu-middle5"
            class="o-ads"  
            data-o-ads-formats-default="false" 
            data-o-ads-formats-small="FtcMobileMpu" 
            data-o-ads-formats-medium="false"
            data-o-ads-formats-large="false"
            data-o-ads-formats-extra="false"
            data-o-ads-targeting="cnpos=middle5;"
            >
            </div>

<h2>Ad Slot: mpu-right2</h2>
<div 
            data-o-ads-name="mpu-right2"
            class="o-ads"  
            data-o-ads-formats-default="false" 
            data-o-ads-formats-small="false" 
            data-o-ads-formats-medium="FtcMpu"
            data-o-ads-formats-large="FtcMpu"
            data-o-ads-formats-extra="FtcMpu"
            data-o-ads-targeting="cnpos=right2;"
            data-cy='[{"devices":["PC","PadWeb","PadApp"],"pattern":"MPU","position":"Right2"}]'
            
            >
            </div>

<h2>Ad Slot: mpu-middle6</h2>
<div 
            data-o-ads-name="mpu-middle6"
            class="o-ads"  
            data-o-ads-formats-default="false" 
            data-o-ads-formats-small="FtcMobileMpu" 
            data-o-ads-formats-medium="false"
            data-o-ads-formats-large="false"
            data-o-ads-formats-extra="false"
            data-o-ads-targeting="cnpos=middle6;"
            >
            </div>

<h2>Ad Slot: banner2</h2>
<div class="o-ads" data-o-ads-name="banner2"
              data-o-ads-center="true" 
              data-o-ads-formats-default="false" 
              data-o-ads-formats-small="FtcMobileBanner" 
              data-o-ads-formats-medium="false"
              data-o-ads-formats-large="FtcLeaderboard"
              data-o-ads-formats-extra="FtcLeaderboard"
              data-o-ads-targeting="cnpos=top2;"
              data-cy='[{"devices":["PC"],"pattern":"Leaderboard","position":"Num2"}]'>
          </div>

<h2>Ad Slot: mpu-right3</h2>
<div 
            data-o-ads-name="mpu-right3"
            class="o-ads"  
            data-o-ads-formats-default="false" 
            data-o-ads-formats-small="false" 
            data-o-ads-formats-medium="FtcMpu"
            data-o-ads-formats-large="FtcMpu"
            data-o-ads-formats-extra="FtcMpu"
            data-o-ads-targeting="cnpos=right3;"
            data-cy='[{"devices":["PC","PadWeb","PadApp"],"pattern":"MPU","position":"Right3"}]'
            
            >
            </div>

<h2>Ad Slot: banner3</h2>
<div class="o-ads" data-o-ads-name="banner3"
              data-o-ads-center="true" 
              data-o-ads-formats-default="false" 
              data-o-ads-formats-small="FtcMobileBanner" 
              data-o-ads-formats-medium="false"
              data-o-ads-formats-large="FtcLeaderboard"
              data-o-ads-formats-extra="FtcLeaderboard"
              data-o-ads-targeting="cnpos=top3;"
              data-cy='[{"devices":["PC"],"pattern":"Leaderboard","position":"Num3"}]'>
          </div>

<h2>Ad Slot: mpu-right4</h2>
<div 
            data-o-ads-name="mpu-right4"
            class="o-ads"  
            data-o-ads-formats-default="false" 
            data-o-ads-formats-small="false" 
            data-o-ads-formats-medium="FtcMpu"
            data-o-ads-formats-large="FtcMpu"
            data-o-ads-formats-extra="FtcMpu"
            data-o-ads-targeting="cnpos=right4;"
            data-cy='[{"devices":["PC","PadWeb","PadApp"],"pattern":"MPU","position":"Right4"}]'
            
            >
            </div>

<h2>Ad Slot: banner4</h2>
<div class="o-ads" data-o-ads-name="banner4"
              data-o-ads-center="true" 
              data-o-ads-formats-default="false" 
              data-o-ads-formats-small="FtcMobileBanner" 
              data-o-ads-formats-medium="false"
              data-o-ads-formats-large="FtcLeaderboard"
              data-o-ads-formats-extra="FtcLeaderboard"
              data-o-ads-targeting="cnpos=top4;"
              data-cy='[{"devices":["PC"],"pattern":"Leaderboard","position":"Num4"}]'>
          </div>

</div>

<button type="button" id="clone-ad-slots" class="clone-btn">Clone ad block</button>

<script>
window.adSetTemplateHTML = document.getElementById('ad-slots').outerHTML;

document.addEventListener('DOMContentLoaded', function () {
    // Optional: Visual debug listener to see border turn green on fill
    if (window.googletag && window.googletag.apiReady) {
        window.googletag.cmd.push(function() {
            window.googletag.pubads().addEventListener('slotRenderEnded', function(event) {
                var slotEl = document.getElementById(event.slot.getSlotElementId());
                if (slotEl) {
                     if (event.isEmpty) {
                        slotEl.style.border = "2px dashed red";
                        slotEl.textContent = "Empty/Collapsed";
                     } else {
                        slotEl.style.border = "2px solid green";
                     }
                }
            });
        });
    }

    var slotsRoot = document.getElementById('ad-slots');
    var cloneBtn = document.getElementById('clone-ad-slots');
    var cloneCount = 0;
    var activeAdSet = slotsRoot;
    
    function createAdSet(index) {
        var wrapper = document.createElement('div');
        wrapper.innerHTML = window.adSetTemplateHTML;
        var container = wrapper.firstElementChild;
        container.setAttribute('data-set-index', index);
        container.querySelector('.ad-set__label').textContent = 'Ad Set #' + index;
        return container;
    }

    if (slotsRoot && cloneBtn) {
        cloneBtn.addEventListener('click', function () {
            cloneCount += 1;
            console.log('[o-ads-demo] --- PWA NAVIGATION START (Simulated) ---');
            
            destroyAllAdSlots(); 
            removeAllAdSets();             

            var clone = createAdSet(cloneCount);
            
            // Insert FIRST (Fixes "Element not found" error)
            cloneBtn.parentNode.insertBefore(clone, cloneBtn);
            activeAdSet = clone;
            
            // Define & Display SECOND (Fixes "Invalid size" error)
            reInitializeAds(clone); 
            
            console.log('[o-ads-demo] --- PWA NAVIGATION END ---');
        });
    }
});
</script>
</body>
</html>