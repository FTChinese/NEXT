<!DOCTYPE html>
<html class="js enhanced" data-next-app="front-page">
 <head>
 <meta charset="utf-8" />
 <meta http-equiv="X-UA-Compatible" content="IE=edge" />
 <title>FT中文网</title>
 <meta http-equiv="Content-Language" content="zh-CN"/>
 <meta name="apple-mobile-web-app-status-bar-style" content="black" />
 <link rel="apple-touch-icon-precomposed" href="https://d2785ji6wtdqx8.cloudfront.net/img/ipad_icon.png" />
 <meta name="viewport" content="width=device-width, initial-scale=1.0" />






<link rel="stylesheet" href="styles/main-pop-ad.css">

<link rel="stylesheet" href="styles/main-paid-post.css">

<link rel="stylesheet" href="styles/main-default.css">

<style>
body {
    padding: clamp(1rem, 3vw, 2.5rem);
    background: #fff7ef;
}
h2 {
    color: #9e2f50;
    font-size: 1.15rem;
}
.ad-set {
    border: 2px dashed #d8b59c;
    padding: 1.5rem;
    margin-bottom: 2rem;
    background: #fff;
}
.ad-set__label {
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.2em;
    color: #a06c4b;
    margin-bottom: 1rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}
.ad-set__label::before,
.ad-set__label::after {
    content: '';
    flex: 1;
    height: 1px;
    background: repeating-linear-gradient(90deg, #a06c4b, #a06c4b 6px, transparent 6px, transparent 12px);
}
.notes {
    background: #fff;
    border-left: 4px solid #9e2f50;
    padding: 1.5rem;
    margin-top: 2rem;
    line-height: 1.6;
}
.notes h3 {
    margin-top: 1rem;
    font-size: 1rem;
}
.notes ol,
.notes ul {
    margin: 0;
    padding-left: 1.25rem;
}
.clone-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    border: 1px solid #9e2f50;
    background: #fff;
    color: #9e2f50;
    font-weight: 600;
    padding: 0.6rem 1.2rem;
    border-radius: 999px;
    cursor: pointer;
    margin: 1rem 0 2rem;
}
.clone-btn:active {
    transform: scale(0.98);
}
.ad-set--inactive {
    opacity: 0.35;
}
pre {
    background: #0f172a;
    color: #f8fafc;
    padding: 1rem;
    overflow-x: auto;
}
</style>





<script type="text/javascript" src="scripts/key.js"></script>
<script type="text/javascript" src="scripts/ad-polyfill.js"></script>


<!-- zone: home-->
<!-- topnav:home subnav: pageId:home-->
<script type="text/javascript">
function parseUserkv(n){var c={},i=n.split(";");if(0!==i.length)return i.forEach(function(n){var i=n.split("|");2===i.length&&(c[i[0]]=i[1])}),c}function getDfpTargetingStr(n){var c="";return n.sex&&(c+="cnsex="+n.sex+";"),n.cs&&(c+="cncs="+n.cs+";"),n.csp&&(c+="cncsp="+n.csp+";"),n.hi&&(c+="cnhi="+n.hi+";"),n.in&&(c+="cnin="+n.in+";"),n.wf&&(c+="cnwf="+n.wf+";"),c}</script>
<script>
function refreshAds(container) {
    if (!container) {
        console.warn('[o-ads-demo] refreshAds called without a container');
        return;
    }
    if (!window.oAds) {
        console.warn('[o-ads-demo] oAds not ready yet');
        return;
    }

    var setIndex = container.getAttribute('data-set-index');
    if (!setIndex) {
        setIndex = Date.now().toString();
        container.setAttribute('data-set-index', setIndex);
    }

    var slotEls = Array.prototype.slice.call(container.querySelectorAll('.o-ads'));
    if (!slotEls.length) {
        console.warn('[o-ads-demo] refreshAds: no slots found inside container');
        return;
    }

    slotEls.forEach(function (slot) {
        var name = slot.getAttribute('data-o-ads-name');
        if (!name) {
            var stored = slot.getAttribute('data-original-name');
            if (stored) {
                slot.setAttribute('data-o-ads-name', stored);
            }
        }

        slot.removeAttribute('data-o-ads-loaded');
        slot.classList.remove('o-ads--empty');

        while (slot.firstChild) {
            slot.removeChild(slot.firstChild);
        }
    });

    var initialised = false;
    if (typeof window.oAds.initSlot === 'function') {
        try {
            slotEls.forEach(function (slot) {
                window.oAds.initSlot(slot);
            });
            initialised = true;
        } catch (err) {
            console.warn('[o-ads-demo] oAds.initSlot failed, fallback to refresh', err);
        }
    }

    if (!initialised && typeof window.oAds.refresh === 'function') {
        try {
            window.oAds.refresh(slotEls);
        } catch (err) {
            console.warn('[o-ads-demo] oAds.refresh failed', err);
        }
    }
}

function deactivateAdSet(container) {
    if (!container) {
        return;
    }
    container.classList.add('ad-set--inactive');
    Array.prototype.slice.call(container.querySelectorAll('.o-ads')).forEach(function (slot) {
        var name = slot.getAttribute('data-o-ads-name');
        if (name) {
            slot.setAttribute('data-original-name', name);
            slot.removeAttribute('data-o-ads-name');
        }
    });
}

function destroyActiveAds(root) {
    if (!window.oAds || typeof window.oAds.destroy !== 'function') {
        return;
    }
    var scope = root || document;
    var slots = Array.prototype.slice.call(scope.querySelectorAll('.ad-set .o-ads'));
    var activeSlots = slots.filter(function (slot) {
        return slot.hasAttribute('data-o-ads-loaded');
    });
    if (activeSlots.length === 0) {
        return;
    }
    try {
        window.oAds.destroy(activeSlots);
    } catch (err) {
        console.warn('[o-ads-demo] destroyActiveAds failed', err);
    }
}

// MARK: - the cookie USER_KV is set from server side when user logs in
var userKv = GetCookie('USER_KV');
var dfpTargetingStr = '';
if (userKv) {
var userKvObj = parseUserkv(userKv);
dfpTargetingStr = getDfpTargetingStr(userKvObj);
}
if (gUserType && gUserType !== '') {
dfpTargetingStr = 'cnuser=' + gUserType + ';' + dfpTargetingStr;
}
//console.log ('Getting user type for google ad manager: ' + window.gUserType);
var configJson = JSON.stringify({
gpt: {
"network": 21753042392,
"site": "FtChinese",
"zone": 'home'
},
collapseEmpty: 'before',
dfp_targeting: dfpTargetingStr,
formats: {
"FtcLeaderboard" : {
"sizes":[[1200, 120], [1200, 400], [1200, 250], [969, 90], [969, 400], [969, 250]]
},
"FtcBanner": {
"sizes":[[1200, 120], [969, 90]]
},
"FtcMobileBanner": {
"sizes": [[414, 104]]
},
"FtcMobileMpu":{
"sizes":[[300, 250]]
},
"FtcMpu":{
"sizes":[[300, 250], [300, 600], [300,1050]]
},
"FtcInfoFlow":{
"sizes":[[400, 300]]
},
"FtcMobileFullscreen": {
"sizes":[[414, 736]]
},
"FtcPcFullscreen":{
"sizes":[[700, 520]]
},
"FtcPaidpost":{
"sizes":[[280, 350]]
},
"FtcRibbon":{
"sizes":[[300, 60]]
},
"FtcMembertext":{
"sizes":[[300, 47]]
}
}
});
var configScriptJsonStr = '<scr'+'ipt data-o-ads-config="" type="application/json">'+configJson+'</scr'+'ipt>';
document.writeln(configScriptJsonStr);
</script>


 </head>
<body>
<div id="ad-slots" class="ad-set" data-set-index="0">
<div class="ad-set__label">Ad Set #0</div>
<h2>Ad Slot: banner1</h2>
<div class="o-ads" data-o-ads-name="banner1"
              data-o-ads-center="true" 
              data-o-ads-formats-default="false" 
              data-o-ads-formats-small="FtcMobileBanner" 
              data-o-ads-formats-medium="false"
              data-o-ads-formats-large="FtcLeaderboard"
              data-o-ads-formats-extra="FtcLeaderboard"
              data-o-ads-targeting="cnpos=top1;"
              data-cy='[{"devices":["PC"],"pattern":"Leaderboard","position":"Num1"}]'>
          </div>

<h2>Ad Slot: infoflow1</h2>
<div data-o-ads-name="infoflow1" class="o-ads infoflow" data-o-ads-formats-default="false" data-o-ads-formats-small="FtcInfoFlow" data-o-ads-formats-medium="false" data-o-ads-formats-large="false" data-o-ads-formats-extra="false" data-o-ads-targeting="cnpos=info1;" ></div>

<h2>Ad Slot: mpu-middle1</h2>
<div data-o-ads-name="mpu-middle1" class="o-ads" data-o-ads-formats-default="false" data-o-ads-formats-small="FtcMobileMpu" data-o-ads-formats-medium="false" data-o-ads-formats-large="false" data-o-ads-formats-extra="false" data-o-ads-targeting="cnpos=middle1;" data-cy='[{"devices":["iPhoneWeb","AndroidWeb","iPhoneApp","AndroidApp"],"pattern":"MPU","position":"Middle1"}]'></div>

<h2>Ad Slot: infoflow2</h2>
<div data-o-ads-name="infoflow2" class="o-ads infoflow" data-o-ads-formats-default="false" data-o-ads-formats-small="FtcInfoFlow" data-o-ads-formats-medium="false" data-o-ads-formats-large="false" data-o-ads-formats-extra="false" data-o-ads-targeting="cnpos=info2;" ></div>

<h2>Ad Slot: mpu-middle2</h2>
<div data-o-ads-name="mpu-middle2" class="o-ads" data-o-ads-formats-default="false" data-o-ads-formats-small="FtcMobileMpu" data-o-ads-formats-medium="false" data-o-ads-formats-large="false" data-o-ads-formats-extra="false" data-o-ads-targeting="cnpos=middle2;" data-cy='[{"devices":["iPhoneWeb","AndroidWeb","iPhoneApp","AndroidApp"],"pattern":"MPU","position":"Middle2"}]'></div>

<h2>Ad Slot: infoflow3</h2>
<div data-o-ads-name="infoflow3" class="o-ads infoflow" data-o-ads-formats-default="false" data-o-ads-formats-small="FtcInfoFlow" data-o-ads-formats-medium="false" data-o-ads-formats-large="false" data-o-ads-formats-extra="false" data-o-ads-targeting="cnpos=info3;" ></div>

<h2>Ad Slot: mpu-middle3</h2>
<div data-o-ads-name="mpu-middle3" class="o-ads" data-o-ads-formats-default="false" data-o-ads-formats-small="FtcMobileMpu" data-o-ads-formats-medium="false" data-o-ads-formats-large="false" data-o-ads-formats-extra="false" data-o-ads-targeting="cnpos=middle3;" data-cy='[{"devices":["iPhoneWeb","AndroidWeb","iPhoneApp","AndroidApp"],"pattern":"MPU","position":"Middle3"}]'></div>

<h2>Ad Slot: infoflow4</h2>
<div data-o-ads-name="infoflow4" class="o-ads infoflow" data-o-ads-formats-default="false" data-o-ads-formats-small="FtcInfoFlow" data-o-ads-formats-medium="false" data-o-ads-formats-large="false" data-o-ads-formats-extra="false" data-o-ads-targeting="cnpos=info4;" ></div>

<h2>Ad Slot: mpu-middle4</h2>
<div data-o-ads-name="mpu-middle4" class="o-ads" data-o-ads-formats-default="false" data-o-ads-formats-small="FtcMobileMpu" data-o-ads-formats-medium="false" data-o-ads-formats-large="false" data-o-ads-formats-extra="false" data-o-ads-targeting="cnpos=middle4;" data-cy='[{"devices":["iPhoneWeb","AndroidWeb","iPhoneApp","AndroidApp"],"pattern":"MPU","position":"Middle4"}]'></div>

<h2>Ad Slot: ribbon</h2>
<div
                data-o-ads-name="ribbon" 
                class="o-ads"
                data-o-ads-formats-default="false"
                data-o-ads-formats-small="false"
                data-o-ads-formats-medium="false"
                data-o-ads-formats-large="FtcRibbon"
                data-o-ads-targeting="cnpos=ribbon;"
            >
            </div>

<h2>Ad Slot: mpu-right1</h2>
<div 
            data-o-ads-name="mpu-right1"
            class="o-ads"  
            data-o-ads-formats-default="false" 
            data-o-ads-formats-small="false" 
            data-o-ads-formats-medium="FtcMpu"
            data-o-ads-formats-large="FtcMpu"
            data-o-ads-formats-extra="FtcMpu"
            data-o-ads-targeting="cnpos=right1;"
            data-cy='[{"devices":["PC","PadWeb","PadApp"],"pattern":"MPU","position":"Right1"}]'
            
            >
            </div>

<h2>Ad Slot: mpu-middle5</h2>
<div 
            data-o-ads-name="mpu-middle5"
            class="o-ads"  
            data-o-ads-formats-default="false" 
            data-o-ads-formats-small="FtcMobileMpu" 
            data-o-ads-formats-medium="false"
            data-o-ads-formats-large="false"
            data-o-ads-formats-extra="false"
            data-o-ads-targeting="cnpos=middle5;"
            >
            </div>

<h2>Ad Slot: mpu-right2</h2>
<div 
            data-o-ads-name="mpu-right2"
            class="o-ads"  
            data-o-ads-formats-default="false" 
            data-o-ads-formats-small="false" 
            data-o-ads-formats-medium="FtcMpu"
            data-o-ads-formats-large="FtcMpu"
            data-o-ads-formats-extra="FtcMpu"
            data-o-ads-targeting="cnpos=right2;"
            data-cy='[{"devices":["PC","PadWeb","PadApp"],"pattern":"MPU","position":"Right2"}]'
            
            >
            </div>

<h2>Ad Slot: mpu-middle6</h2>
<div 
            data-o-ads-name="mpu-middle6"
            class="o-ads"  
            data-o-ads-formats-default="false" 
            data-o-ads-formats-small="FtcMobileMpu" 
            data-o-ads-formats-medium="false"
            data-o-ads-formats-large="false"
            data-o-ads-formats-extra="false"
            data-o-ads-targeting="cnpos=middle6;"
            >
            </div>

<h2>Ad Slot: banner2</h2>
<div class="o-ads" data-o-ads-name="banner2"
              data-o-ads-center="true" 
              data-o-ads-formats-default="false" 
              data-o-ads-formats-small="FtcMobileBanner" 
              data-o-ads-formats-medium="false"
              data-o-ads-formats-large="FtcLeaderboard"
              data-o-ads-formats-extra="FtcLeaderboard"
              data-o-ads-targeting="cnpos=top2;"
              data-cy='[{"devices":["PC"],"pattern":"Leaderboard","position":"Num2"}]'>
          </div>

<h2>Ad Slot: mpu-right3</h2>
<div 
            data-o-ads-name="mpu-right3"
            class="o-ads"  
            data-o-ads-formats-default="false" 
            data-o-ads-formats-small="false" 
            data-o-ads-formats-medium="FtcMpu"
            data-o-ads-formats-large="FtcMpu"
            data-o-ads-formats-extra="FtcMpu"
            data-o-ads-targeting="cnpos=right3;"
            data-cy='[{"devices":["PC","PadWeb","PadApp"],"pattern":"MPU","position":"Right3"}]'
            
            >
            </div>

<h2>Ad Slot: banner3</h2>
<div class="o-ads" data-o-ads-name="banner3"
              data-o-ads-center="true" 
              data-o-ads-formats-default="false" 
              data-o-ads-formats-small="FtcMobileBanner" 
              data-o-ads-formats-medium="false"
              data-o-ads-formats-large="FtcLeaderboard"
              data-o-ads-formats-extra="FtcLeaderboard"
              data-o-ads-targeting="cnpos=top3;"
              data-cy='[{"devices":["PC"],"pattern":"Leaderboard","position":"Num3"}]'>
          </div>

<h2>Ad Slot: mpu-right4</h2>
<div 
            data-o-ads-name="mpu-right4"
            class="o-ads"  
            data-o-ads-formats-default="false" 
            data-o-ads-formats-small="false" 
            data-o-ads-formats-medium="FtcMpu"
            data-o-ads-formats-large="FtcMpu"
            data-o-ads-formats-extra="FtcMpu"
            data-o-ads-targeting="cnpos=right4;"
            data-cy='[{"devices":["PC","PadWeb","PadApp"],"pattern":"MPU","position":"Right4"}]'
            
            >
            </div>

<h2>Ad Slot: banner4</h2>
<div class="o-ads" data-o-ads-name="banner4"
              data-o-ads-center="true" 
              data-o-ads-formats-default="false" 
              data-o-ads-formats-small="FtcMobileBanner" 
              data-o-ads-formats-medium="false"
              data-o-ads-formats-large="FtcLeaderboard"
              data-o-ads-formats-extra="FtcLeaderboard"
              data-o-ads-targeting="cnpos=top4;"
              data-cy='[{"devices":["PC"],"pattern":"Leaderboard","position":"Num4"}]'>
          </div>

</div>

<button type="button" id="clone-ad-slots" class="clone-btn">Clone ad block</button>

<script>
window.adSlotsTemplateHTML = document.getElementById('ad-slots').innerHTML;
</script>

<section class="notes">
    <h2>FTChinese 如何通过 o-ads 渲染 Google Ad Manager 广告</h2>
    <ol>
        <li><strong>环境初始化 (`scripts/key.js`).</strong> 该脚本解析用户/设备 cookie，计算 <code>gUserType</code>、<code>USER_KV</code> 等值并暴露 <code>GetCookie</code>。广告定向字符串（例如 <code>cnuser=ChurnedVIP;</code>）必须在此阶段准备好，否则 DFP 不会匹配到上架的订单。</li>
        <li><strong>加载 o-ads 框架 (`scripts/ad-polyfill.js`).</strong> 该文件会根据浏览器能力注入必要的 polyfill，然后按顺序加载 shrinkwrap 过的 <code>o-ads</code> + GPT bundle（含 <code>o-autoinit</code>）。只有在这个 bundle 完成后，页面上的 <code>.o-ads</code> 才会被自动扫描。</li>
        <li><strong>声明式配置。</strong> o-ads 在 DOM 中查找 <code>&lt;script data-o-ads-config type="application/json"&gt;</code>，我们在其中描述 network、site、zone、<code>collapseEmpty</code> 策略，以及 <code>formats</code>（FT 自定义的 FtcLeaderboard、FtcMpu 等尺寸）。</li>
        <li><strong>Slot 标记。</strong> 每个广告位都是一个带 <code>class="o-ads"</code> 的容器，使用 <code>data-o-ads-formats-*</code> 定义各断点尺寸，<code>data-o-ads-targeting</code> 提供位置信息（如 <code>cnpos=top1;</code>），必要时还可设置 <code>data-o-ads-center</code>、<code>data-o-ads-lazy-load</code> 等属性覆盖全局行为。</li>
        <li><strong>事件与调试。</strong> o-ads 在渲染生命周期中会发出 <code>oAds.slotRenderStart</code>、<code>oAds.slotRenderEnded</code> 等事件。下面的监听器示例会把每个 slot 的最终格式写到控制台，方便确认 GPT 是否返回了创意。</li>
    </ol>
</section>

<section class="notes">
    <h2>官方 README 提到的进阶技巧（适用于独立 Web App / SPA）</h2>
    <ul>
        <li><strong>编程式初始化。</strong> 在独立应用里可以通过 npm 直接 <code>import oAds</code> 并调用 <code>oAds.init</code>，而不是依赖 <code>data-o-ads-config</code>。示例：
            <pre><code>import oAds from '@financial-times/o-ads';
oAds.init({
    gpt: { network: 21753042392, site: 'FtChinese', zone: 'labs' },
    collapseEmpty: 'after',
    lazyLoad: true
});</code></pre>
            在单页应用里，当路由变化后可重用同一实例并调用 <code>oAds.refresh()</code> 让可见的 slot 重新向 GAM 请求。</li>
        <li><strong>Lazy Loading / Master-Companion.</strong> 通过全局 <code>lazyLoad</code> 配置（或 slot 级 <code>data-o-ads-lazy-load</code>）可以控制 IntersectionObserver 触发阈值。README 还注明 Master/Companion 创意会绕过懒加载并立即触发同组广告。</li>
        <li><strong>自定义断点与格式。</strong> 使用 <code>oAds.config({ responsive: {...} })</code> 可以覆写 small/medium/large/extra 的 px 范围，从而在特殊页面请求不同的 Ftc 格式或你自定义的 format 名称。</li>
        <li><strong>slot 层定制。</strong> README 列出了全部 <code>data-o-ads-*</code> 属性，包括 <code>data-o-ads-collapse-empty</code>、<code>data-o-ads-out-of-page</code>（承载 interstitial）、<code>data-o-ads-loaded</code>（渲染后由 o-ads 写回，可配合 CSS 或观察者改变布局）。</li>
        <li><strong>Metrics & Monitoring.</strong> 通过 <code>oAds.utils.setupMetrics()</code> 可以把多个事件组合成一次监控上报：
            <pre><code>oAds.utils.setupMetrics([
  {
    name: 'slot-rendered',
    marks: ['slotRenderStart','slotRenderEnded'],
    trigger: 'slotRenderEnded',
    callback: (data) => console.log('render time', data)
  }
]);</code></pre>
            如果在 SPA 中重复导航，可调用 <code>oAds.utils.clearPerfMarks()</code> 清空旧的 performance entries。</li>
    </ul>
</section>

<script>
document.addEventListener('DOMContentLoaded', function () {
    if (window.oAds && typeof window.oAds.on === 'function') {
        window.oAds.on('slotRenderEnded', function (slot) {
            var format = slot.container && slot.container.getAttribute('data-o-ads-loaded');
            console.log('[o-ads-demo]', slot.name, '->', format || 'empty');
        });
    }

    var slotsRoot = document.getElementById('ad-slots');
    var cloneBtn = document.getElementById('clone-ad-slots');
    var adSetTemplateHTML = window.adSlotsTemplateHTML || (slotsRoot ? slotsRoot.innerHTML : '');
    var cloneCount = 0;
    var activeAdSet = slotsRoot;
    function createAdSet(index) {
        var container = document.createElement('div');
        container.className = 'ad-set';
        container.setAttribute('data-set-index', index);
        container.innerHTML = adSetTemplateHTML;
        var label = container.querySelector('.ad-set__label');
        if (label) {
            label.textContent = 'Ad Set #' + index;
        }
        return container;
    }
    if (slotsRoot && cloneBtn) {
        cloneBtn.addEventListener('click', function () {
            cloneCount += 1;
            destroyActiveAds(activeAdSet || document);
            deactivateAdSet(activeAdSet);
            var clone = createAdSet(cloneCount);
            cloneBtn.parentNode.insertBefore(clone, cloneBtn);
            clone.classList.remove('ad-set--inactive');
            activeAdSet = clone;
            refreshAds(activeAdSet);
        });
    }
});
</script>

</body>


</html>
