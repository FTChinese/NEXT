<%assign var="pageIdForPromo" value="subcription-promo"%>
<%if $nextmodel != ""%>
	<%assign var="infoForPromo" value=$nextmodel->getPublishJson($pageIdForPromo)|json_decode:true%>
	<%assign var="promoRendered" value=""%>
		<%if $supportSubscriptionUpgradePromo != "yes"%>
		<%assign var="promoRendered" value="standardpremium"%>
	<%/if%>
	<%if $smarty.get.webview == "ftcapp"%>
		<%assign var="inAppClass" value=" in-app"%>
		<%*<!--MARK: - In native app, don't ever show promo box for non-subscriber as it is fixed to the bottom -->*%>
		<%assign var="promoRendered" value="noneSubscriber`$promoRendered`"%>
	<%/if%>
	<%assign var="hasPromo" value="no"%>
	<%foreach from=$infoForPromo.sections item=section%>
	    <%if $section.type == "promoBox" && $section.status == "on" && !preg_match("/`$section.promoTarget`/is",$promoRendered)%>
	    	<%assign var="hasPromo" value="yes"%>
	    	<style>
	    	<%if $section.backgroundColor != ""%>
		    	.<%$section.promoTarget%>.subscription-promo-container {
		    		background-color: <%$section.backgroundColor%>;
		    	}
	    	<%/if%>
	    	.<%$section.promoTarget%> .subscription-promo-box {
	    		background-image: url(<%$section.imagePC%>);
	    	}
	    	<%if $section.imageMobile != ""%>
				<%assign var="showImageInMobile" value=" show-image-in-mobile"%>
				@media only screen and (max-width: 490px) {
			    	.<%$section.promoTarget%> .subscription-promo-box {
			    		background-image: url(<%$section.imageMobile%>);
			    	}
				}
			<%else%>
				<%assign var="showImageInMobile" value=""%>
	    	<%/if%>
	    	</style>
	    	<%if preg_match("/ccode=/is",$section.click)%>
				<%assign var=clickUrl value=$section.click%>
			<%elseif preg_match("/\?/is",$section.click)%>
				<%assign var=clickUrl value="`$section.click`&ccode=`$section.ccode`"%>
			<%else%>
				<%assign var=clickUrl value="`$section.click`?ccode=`$section.ccode`"%>
			<%/if%>
			<div class="subscription-promo-container<%$inAppClass%><%$showImageInMobile%> <%$section.promoTarget%>">
			    <div class="subscription-promo-inner">
			        <a href="<%$clickUrl%>" class="subscription-promo-box n-internal-promo" data-promo-target="<%$section.promoTarget%>" data-promo-id="<%$section.promoId%>" data-promo-name="<%$section.title%>" data-promo-creative="<%$section.imagePC%>" data-promo-position="<%$section.type%>">
			            <div class="subscription-promo-text"><%$section.title%></div>
			        </a>
			    </div>
			</div>
			<%assign var="promoRendered" value="`$promoRendered``$section.promoTarget`"%>
	    <%/if%>
	<%/foreach%>
	<%if $hasPromo === "yes"%>
		<script type="text/javascript">
			
			function trackInternalPromos() {
				var allPromos = document.querySelectorAll('.n-internal-promo');
				for (var i=0; i<allPromos.length; i++) {
					var currentPromo = allPromos[i];
					var promoTarget = currentPromo.getAttribute('data-promo-target');
					var promoId = currentPromo.getAttribute('data-promo-id');
					var promoName = currentPromo.getAttribute('data-promo-name');
					var promoCreative = currentPromo.getAttribute('data-promo-creative');
					var promoPosition = currentPromo.getAttribute('data-promo-position');
					// MARK: Use a set timeout to track display. 
					setTimeout(function() {
						if (isHidden(currentPromo) === false) {
							ga('ec:addPromo', {
							  'id': promoId,
							  'name': promoName,
							  'creative': promoCreative,
							  'position': promoPosition
							});
							ga('send','event','Web Privileges', 'Display', 'From:' + promoId);
						}
					}, 3000);
					currentPromo.onclick = function() {
						ga('ec:addPromo', {
						  'id': promoId,
						  'name': promoName,
						  'creative': promoCreative,
						  'position': promoPosition
						});
						ga('ec:setAction', 'promo_click');
						var theLink = this.href;
						ga('send','event','Web Privileges', 'Tap', 'From:' + promoId, {
						    hitCallback: function() {
								document.location = theLink;
						    }
						});
						// MARK: If for some reason GA is not accessible, redirectly regardless
						setTimeout(function(){
							document.location = theLink;
						}, 3000);
						// MARK: Track the event then go to link 
						return !ga.loaded;
					};
				}
			}
			trackInternalPromos();
		</script>
	<%/if%>
<%/if%>