<style><%include file="next/styles/main-form-subscription.css"%></style>
<div class="list-container">
	<div class="list-inner">
		<%if $list.title != ""%>
			<h2 class="list-title">
				<a class="list-link" href="#"><%$list.title%></a>
			</h2>
		<%/if%>
		<%if $list.description != ""%>
			<div class="items">
				<div class="no-image">
					<div class="item-inner">
						<div class="item-lead" id="subscription-form-description"><%$list.description%></div>
					</div>
				</div>
			</div>
		<%/if%>
		<div class="items">
			<div class="no-image">
				<div class="item-inner">
					<div class="subscription-form-container">
						<div><span>邮件：</span><input type="email" placeholder="请准确填写您的邮件地址" class="email" id="email"><span class="status"></span></div>
            <%assign var=telType value="tel"%>
            <%if $list.InfoCollection == "china_only"%>
              <%assign var=telType value="chinamobile"%>
            <%/if%>
            <div><span>手机：</span><input type="<%$telType%>" placeholder="请准确填写号码" class="<%$telType%>" id="mobile_phone_no"><span class="status"></span></div>
            <%if $list.InfoCollection != "basic"%>
              <div><span>地址：</span><input type="text" placeholder="请填写准确地址" class="address" id="address"><span class="status"></span></div>
              <div><span>姓：</span><input type="text" placeholder="" class="last-name" id="last_name"><span class="status"></span></div>
              <div><span>名：</span><input type="text" placeholder="" class="first-name" id="first_name"><span class="status"></span></div>
            <%/if%>
            <div class="item-lead terms">
              请您阅读我们的<a href="/m/corp/service.html" target="_blank">用户注册协议</a>和<a href="/m/corp/service.html#privacy" target="_blank">隐私权保护政策</a>，点击下方按钮即视为您接受。
            </div>
						<div class="center n-button-container">
							<button class="n-button-inner subscription-button" id="subscription-button">确认并提交</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<script type="text/javascript">
    var isSubmiting = false;
    var validators = {
      chinamobile: {
        reg: /^[0-9]{11}$/,
        warning: '请填写11位数字的中国大陆手机号码，不要使用任何其他符号'
      },
      tel: {
        reg: /^[0-9\ ]{8,}$/,
        warning: '请填写数字的手机号码，不要使用全角或符号'
      },
      email: {
        reg: /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,
        warning: '请填写格式正确的邮件地址'
      }
    };

    function kickStart() {
      var inputs = document.querySelectorAll('.subscription-form-container input');
      for (var i=0; i<inputs.length; i++) {
        inputs[i].onblur = function() {
          validateInput(this);
        }
      }
      getExistingInfo();
      showApplePurchaseInfo();
    }

    function showApplePurchaseInfo() {
      if (typeof webkit === 'object' && webkit.messageHandlers) {
        var message = '<div class="important-info">如您当前的订阅尚未到期，将在当前订阅到期后扣款。请勿关闭自动续费，以保证续费时按照您见到的金额扣款。 </div>';
        var info = document.getElementById('subscription-form-description');
        info.innerHTML = message + info.innerHTML;
      }
    }

    function validateInput(ele) {
      var inputValue = ele.value;
      var statusEle = ele.parentNode.querySelector('.status');
      var key = ele.getAttribute('type');
      if (!key) {return;}
      var v = validators[key];
      if (!v) {return;}
      var validator = v.reg;
      var warningMessage = v.warning;
      
      ele.className = ele.className.replace(/ wrong/g, '');
      if (validator.test(inputValue)) {
        statusEle.innerHTML = '';
        return true;
      } else {
        this.className += ' wrong';
        statusEle.innerHTML = warningMessage;
        return false;
      }
    }

    function getExistingInfo() {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', '/index.php/user/info/');
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.onload = function() {
          if (xhr.status === 200) {
              /* console.log(xhr.responseText); */
              var info = JSON.parse(xhr.responseText);
              var inputs = document.querySelectorAll('.subscription-form-container input');
              for (var i=0; i<inputs.length; i++) {
                var id = inputs[i].id;
                if (id && info[id]) inputs[i].value = info[id];
              }
          }
      };
      xhr.send();
    }

    function finishSubmit() {
      isSubmiting = false;
      if (window.location.search.indexOf('webview=ftcapp')>=0) {
        document.getElementById('subscription-button').innerHTML = '再次提交';
      } else {
        document.getElementById('subscription-button').parentElement.innerHTML = '<a href="/">提交成功，点击进入订户专享网站</a>';
      }
      sendAlert({
        title: '成功',
        message: '您已经成功提交了信息'
      });
      markSuccess();
    }

    function sendAlert(obj) {
      try {
        webkit.messageHandlers.alert.postMessage(obj);
      } catch (error) {
        alert (obj.message);
      }
    }

    function markSuccess() {
      var userdefault = {
        key: 'Need To Confirm Info',
        value: false
      }
      try {
        webkit.messageHandlers.userdefault.postMessage(userdefault);
      } catch (error) {
        DeleteCookie('NeedToConfirmInfo');
      }
    }

    document.getElementById('subscription-button').onclick = function(){
      if (isSubmiting) return;
      var userData = {}
      var inputs = document.querySelectorAll('.subscription-form-container input');
      for (var i=0; i<inputs.length; i++) {
        if (validateInput(inputs[i]) === false) {return;}
        var id = inputs[i].id;
        var value = inputs[i].value;
        userData[id] = value;
      }
      this.innerHTML = '提交中...';
      isSubmiting = true;
      var xhr = new XMLHttpRequest();
      xhr.open('POST', '/index.php/user/confirminfo');
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.onload = function() {
        if (xhr.status === 200) {return;}
        var result = JSON.parse(xhr.responseText);
        if (result.status === 'success') {finishSubmit();}
      };
      xhr.send(JSON.stringify(userData));
    }

    kickStart();
</script>